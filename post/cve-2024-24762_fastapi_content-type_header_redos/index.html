<!doctype html>
<html lang="en-us"><head>
    <title>YuAn SEC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../images/avatar1.png"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        YuAn
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    Researcher&amp;Developer
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../post/" title="Posts">Posts</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../categories/" title="Categories">Categories</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="https://github.com/yuansec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://twitter.com/Sec1uan" target="_blank">
                            <i class="fab fa-twitter fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:yuansec@outlook.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />

</header>
<div class="container">
    <div class="pl-sm-2">
        <div class="mb-3">
            <h3 class="mb-0">CVE 2024 24762_FastAPI_Content Type_Header_ReDoS</h3>
            
            <small class="text-muted">Published February 7, 2024</small>
        </div>

        <article>
            <h2 id="一组件简介">一、组件简介</h2>
<p><a href="https://fastapi.tiangolo.com/zh/">https://fastapi.tiangolo.com/zh/</a></p>
<p>FastAPI 是一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.8+ 并基于标准的 Python 类型提示。</p>
<h2 id="二漏洞详情">二、漏洞详情</h2>
<h3 id="1-介绍">1. 介绍</h3>
<p>FastAPI is a web framework for building APIs with Python 3.8+ based on standard Python type hints. When using form data, <code>python-multipart</code> uses a Regular Expression to parse the HTTP <code>Content-Type</code> header, including options. An attacker could send a custom-made <code>Content-Type</code> option that is very difficult for the RegEx to process, consuming CPU resources and stalling indefinitely (minutes or more) while holding the main event loop. This means that process can&rsquo;t handle any more requests. It&rsquo;s a ReDoS(Regular expression Denial of Service), it only applies to those reading form data, using <code>python-multipart</code>. This vulnerability has been patched in version 0.109.0.</p>
<p>根据描述，当使用表单数据时，python-multipart使用了正则表达式去解析Content-Type头，攻击者可以发送正则匹配较难处理的自定义的Content-Type配置，这会导致无法处理其他的请求，最终导致ReDoS问题，在0.109.0被修复</p>
<h3 id="2-影响范围">2. 影响范围</h3>
<p>&lt;0.109.1</p>
<h3 id="3漏洞分析">3.漏洞分析</h3>
<p>根据描述，漏洞利用是使用python-multipart读取表单数据。fastapi如果要使用表单，需预先安装 <a href="https://andrew-d.github.io/python-multipart/"><code>python-multipart</code></a>。</p>
<p>根本原因是python-multipart导致的：https://github.com/andrew-d/python-multipart/commit/20f0ef6b4e4caf7d69a667c54dff57fe467109a4</p>
<p>fastapi这里写的很清楚：https://github.com/tiangolo/fastapi/security/advisories/GHSA-qf9m-vfgh-m389</p>
<p>在解析<code>Content-Type: application/x-www-form-urlencoded; !=&quot;\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</code>时，会导致ReDos的问题</p>
<h4 id="31环境搭建">3.1环境搭建</h4>
<pre tabindex="0"><code>pip3 install fastapi==0.109.0
pip3 install &#34;uvicorn[standard]&#34;
</code></pre><p>main.py</p>
<pre tabindex="0"><code>import uvicorn

from fastapi import FastAPI, Form

app = FastAPI()


@app.get(&#34;/&#34;)
def read_root():
    return {&#34;Hello&#34;: &#34;World&#34;}

@app.post(&#34;/login/&#34;)
async def login(username: str = Form(), password: str = Form()):
    return {&#34;username&#34;: username}
</code></pre><p>运行：<code>uvicorn main:app --reload</code></p>
<h4 id="32代码分析">3.2代码分析</h4>
<p>关键代码：</p>
<p><img src="../../image-20240206164025651.png" alt="image-20240206164025651"></p>
<p>创建路由时，会根据body_field and isinstance判断is_body_form</p>
<p><img src="../../image-20240206165116838.png" alt="image-20240206165116838"></p>
<p>当is_body_form=True时，会调用 request.form()，内部执行parse_options_header，将<code>;</code>后的内容进行正则匹配，从而触发ReDos</p>
<p><img src="../../image-20240206165219213.png" alt="image-20240206165219213"></p>
<p>验证结果</p>
<p><img src="../../image-20240206164552664.png" alt="image-20240206164552664"></p>
<h4 id="33漏洞修复分析">3.3漏洞修复分析</h4>
<p>去掉了正则表达式解析</p>
<p><img src="../../image-20240206165743460.png" alt="image-20240206165743460"></p>

        </article>
    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; Copyright 2024, YuAn
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
		
		<div class="busuanzi-footer">
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div></small>
	

</footer>
</body>
</html>
