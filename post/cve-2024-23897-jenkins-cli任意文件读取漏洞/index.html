<!doctype html>
<html lang="en-us"><head>
    <title>YuAn SEC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="" />

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    

	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade">
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../images/avatar1.png"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        YuAn
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    Researcher&amp;Developer
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../about/" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../post/" title="Posts">Posts</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../categories/" title="Categories">Categories</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="https://github.com/yuansec" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://twitter.com/Sec1uan" target="_blank">
                            <i class="fab fa-twitter fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:yuansec@outlook.com" target="_blank">
                            <i class="fas fa-at fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />

</header>
<div class="container">
    <div class="pl-sm-2">
        <div class="mb-3">
            <h3 class="mb-0">CVE 2024 23897 Jenkins CLI任意文件读取漏洞</h3>
            
            <small class="text-muted">Published February 5, 2024</small>
        </div>

        <article>
            <h2 id="一组件简介">一、组件简介</h2>
<p>Jenkins是一个开源的自动化服务器，用于实现持续集成和持续交付（CI/CD）。它提供了一个可扩展的平台，用于构建、测试和部署软件项目。</p>
<p>Jenkins的主要功能包括：</p>
<ol>
<li>自动化构建：Jenkins可以根据预定义的构建脚本或配置文件自动构建项目。它支持各种编程语言和构建工具，如Java、Python、Maven和Gradle。</li>
<li>持续集成：Jenkins可以与版本控制系统（如Git、Subversion）集成，以便在代码提交时自动触发构建和测试过程。它可以检测代码变更并执行相应的构建任务。</li>
<li>测试和报告：Jenkins可以与各种测试框架和工具集成，如JUnit、Selenium和JMeter。它可以自动运行测试套件，并生成测试报告和覆盖率报告。</li>
<li>部署和交付：Jenkins可以与部署工具和云平台集成，如Docker、Kubernetes和AWS。它可以自动化部署应用程序到不同的环境，并支持持续交付流程。</li>
<li>插件生态系统：Jenkins拥有一个丰富的插件生态系统，提供了各种功能扩展和集成选项。用户可以根据自己的需求选择和安装适合的插件。</li>
</ol>
<p>Jenkins的灵活性和可扩展性使其成为持续集成和持续交付的首选工具之一。它被广泛应用于软件开发和DevOps团队中，帮助实现自动化构建、测试和部署的流程，提高软件交付的质量和效率。</p>
<h2 id="二漏洞详情">二、漏洞详情</h2>
<h3 id="1-介绍">1. 介绍</h3>
<p>Jenkins 2.441 and earlier, LTS 2.426.2 and earlier does not disable a feature of its CLI command parser that replaces an &lsquo;@&rsquo; character followed by a file path in an argument with the file&rsquo;s contents, allowing unauthenticated attackers to read arbitrary files on the Jenkins controller file system.</p>
<p>Jenkins 2.441 及更早版本、LTS 2.426.2 及更早版本不会禁用其 CLI 命令解析器的一项功能，可以将<code>@</code>参数中后跟文件路径的字符替换为文件内容 ( <code>expandAtFiles</code>)，从而允许未经身份验证的攻击者读取Jenkins 控制器文件系统。</p>
<h3 id="2-影响范围">2. 影响范围</h3>
<p>&lt;=Jenkins 2.441</p>
<p>&lt;=Jenkins LTS 2.426.2</p>
<h3 id="3漏洞分析">3.漏洞分析</h3>
<p>根据漏洞描述，是由于@会替换成文件内容，所以导致的信息泄露，根据官网说明和分析，问题属于SECURITY-3314，commit应该是：https://github.com/jenkinsci/jenkins/commit/554f03782057c499c49bbb06575f0d28b5200edb</p>
<p>直接将命令修改下就可以利用了，poc：<code>java -jar jenkins-cli.jar -s http://x.x.x.x:8080/ help @/etc/passwd</code>，有的文件不需要认证就可以读取，有的文件行数比较多的需要认证才能读取</p>
<p><img src="../../image-20240127113838833.png" alt="image-20240127113838833"></p>
<p><img src="../../image-20240127114120804.png" alt="image-20240127114120804"></p>
<p><img src="../../image-20240127114720987.png" alt="image-20240127114720987"></p>
<h4 id="31环境搭建">3.1环境搭建</h4>
<p>先访问github搭建2.441的环境</p>
<p><a href="https://github.com/jenkinsci/jenkins/archive/refs/tags/jenkins-2.441.zip">https://github.com/jenkinsci/jenkins/archive/refs/tags/jenkins-2.441.zip</a> 源码</p>
<p><a href="https://github.com/jenkinsci/jenkins/releases/download/jenkins-2.441/jenkins.war">https://github.com/jenkinsci/jenkins/releases/download/jenkins-2.441/jenkins.war</a> 部署运行的，vps上通过<code> java -jar jenkins.war --httpPort=8080</code>执行</p>
<p>jenkins-cli是jenins的管理工具，可以从搭建好的8080应用上直接下载：<code>wget http://172.16.0.147:8080/jnlpJars/jenkins-cli.jar</code></p>
<p>使用也比较简单：<code>java -jar jenkins-cli.jar -s http://172.16.0.147:8080/ help</code></p>
<p><img src="../../image-20240127112250620.png" alt="image-20240127112250620"></p>
<h4 id="32代码分析">3.2代码分析</h4>
<p>将启动参数加入 进行debug：<code>java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 -jar jenkins.war</code>。看下代码的底层逻辑。</p>
<p>根据commit下对应的断点，可以看到poc中的<code>@/etc/shadow</code>被当作参数传递到jenkins服务端</p>
<p>继续跟进到org.kohsuke.args4j.CmdLineParser#parseArgument(java.lang.String&hellip;)中的expandAtFiles()方法</p>
<p><img src="../../image-20240127145135522.png" alt="image-20240127145135522"></p>
<p>方法内会判断如果以@开头，且文件存在的话，会读取文件的内容</p>
<p><img src="../../image-20240127145349107.png" alt="image-20240127145349107"></p>
<p>会导致读取文件内容当作命令的参数赋值给expandedArgs，最终会把部分内容放入到报错信息中，返回给连接者</p>
<p>其中有几种情况</p>
<table>
<thead>
<tr>
<th>是否认证</th>
<th>读取文件是单行/多行</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>未认证</td>
<td>单行</td>
<td>可以读</td>
</tr>
<tr>
<td>未认证</td>
<td>多行</td>
<td>前3行(help是前2行)</td>
</tr>
<tr>
<td>已认证</td>
<td>单行</td>
<td>可以读</td>
</tr>
<tr>
<td>已认证</td>
<td>多行</td>
<td>可以读</td>
</tr>
</tbody>
</table>
<p>使用help命令，如果未认证且读取的文件是多行的，会把第一、二行内容返回，无需认证</p>
<p><img src="../../image-20240127151940345.png" alt="image-20240127151940345"></p>
<p><img src="../../image-20240127152525880.png" alt="image-20240127152525880"></p>
<p><img src="../../image-20240127161016509.png" alt="image-20240127161016509"></p>
<p>如果执行help未认证且读取单行文件的话，由于参数数量没有问题，所以不会报CmdLineException错，执行到run()时，会由于没有认证而导致报AccessDeniedException错，返回的是通用报错信息，不会返回参数值，因此通过help命令无认证的用户无法读取单行的文件</p>
<p><img src="../../image-20240127161747983.png" alt="image-20240127161747983"></p>
<p>其他的命令有两类：CLICommand、CLIRegisterer，后续执行command.main逻辑不同</p>
<p><img src="../../image-20240127173047720.png" alt="image-20240127173047720"></p>
<p>如果是CLICommand类的命令，会先校验权限，如果不是help和whoami，都会执行到checkPermission报AccessDeniedException错</p>
<p><img src="../../image-20240127173518026.png" alt="image-20240127173518026"></p>
<p>如果是CLIRegisterer类型的（keep-build、restart、shutdown、safe-shutdown、disable-job、enable-job），检查权限是在解析参数之后</p>
<p><img src="../../image-20240127174117384.png" alt="image-20240127174117384"></p>
<p>因此如果解析参数时报错，就可以获取敏感信息，因此可以通过多个参数来使CLIRegisterer类型的命令在解析参数时报错</p>
<p>如使用keep-build命令可以读取单行文件</p>
<p><img src="../../image-20240127170156331.png" alt="image-20240127170156331"></p>
<p>也可以读取第三行</p>
<p><img src="../../image-20240127170406544.png" alt="image-20240127170406544"></p>
<p>使用restart命令读取单行文件</p>
<p><img src="../../image-20240127174359427.png" alt="image-20240127174359427"></p>
<p>认证之后情况类似</p>
<p>如果命令有1个参数，那么可以通过报错获取文件的第1、2行内容，如果有2个参数，可以获取第1、2、3行的内容，目前CLI的命令应该就是keep-build的参数是2个，所以最多可以读取3行内容</p>
<h4 id="33漏洞修复分析">3.3漏洞修复分析</h4>
<p>修复是加了ALLOW_AT_SYNTAX，默认为false</p>
<p><img src="../../image-20240127162746465.png" alt="image-20240127162746465"></p>
<p><img src="../../image-20240127172535630.png" alt="image-20240127172535630"></p>
<p>解析参数的时候parserProperties.getAtSyntax()返回false，就不会对参数进行解析了</p>
<p><img src="../../image-20240127163928557.png" alt="image-20240127163928557"></p>
<h2 id="三排查修复建议">三、排查修复建议</h2>
<h2 id="四可能的挖掘点">四、可能的挖掘点</h2>
<p>SSRF：不可以，@filepath不会解析了，之前的版本可以</p>
<p>如果有admin权限的话，就可以直接执行Script Console，从而执行系统命令，控制服务器</p>
<p><img src="../../image-20240201114335927.png" alt="image-20240201114335927"></p>
<h2 id="五总结启发思考必填">五、总结启发思考（必填）</h2>
<p>漏洞挖掘方法，漏洞分析方法，启发等</p>
<h2 id="六payload积累templates或其他">六、payload积累（templates或其他）</h2>
<h2 id="七参考">七、参考</h2>
<p><a href="https://www.jenkins.io/security/advisory/2024-01-24/">https://www.jenkins.io/security/advisory/2024-01-24/</a></p>
<p><a href="https://github.com/jenkinsci-cert/SECURITY-3314-3315/">https://github.com/jenkinsci-cert/SECURITY-3314-3315/</a></p>

        </article>
    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
            &copy; Copyright 2024, YuAn
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
		
		<div class="busuanzi-footer">
  <span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv">
    本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
</div></small>
	

</footer>
</body>
</html>
